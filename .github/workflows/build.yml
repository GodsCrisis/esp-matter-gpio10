name: Build ESP32-H2 GPIO10 NMOS Controller

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Free up disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet \
                /usr/local/lib/android \
                /opt/ghc \
                /usr/local/share/boost \
                /usr/local/lib/node_modules \
                /opt/hostedtoolcache \
                "$AGENT_TOOLSDIRECTORY"
            sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' '^php.*' \
              azure-cli google-chrome-stable firefox powershell mono-devel \
              2>/dev/null || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          docker system prune -af || true
          echo "=== After cleanup ==="
          df -h  
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Ensure submodules are initialized
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-venv \
            cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0 \
            git-lfs pkg-config libglib2.0-dev libpixman-1-dev libgcrypt20-dev
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Disable cache compression to save disk space
        run: |
          echo "ACTIONS_CACHE_COMPRESSION_LEVEL=0" >> $GITHUB_ENV
      - name: Cache ESP-IDF tools
        uses: actions/cache@v4
        with:
          path: ~/.espressif
          key: esp-idf-tools-${{ runner.os }}-v5.4.1
          
      - name: Install ESP-IDF v5.4.1
        run: |
          mkdir -p ~/esp
          cd ~/esp
          echo "Cloning ESP-IDF v5.4.1..."
          git clone --recursive --shallow-submodules --branch v5.4.1 --depth 1 https://github.com/espressif/esp-idf.git
          cd esp-idf
          echo "Installing ESP-IDF tools for ESP32-H2..."
          ./install.sh esp32h2
          echo "ESP-IDF installation complete"
      
      - name: Install ESP-Matter dependencies
        run: |
          # Install in the current repository
          echo "Installing ESP-Matter dependencies..."
          ./install.sh
          echo "ESP-Matter installation complete"
      - name: Ensure activate.sh is executable
        run: |
          if [ -f ./connectedhomeip/connectedhomeip/scripts/activate.sh ]; then
            chmod +x ./connectedhomeip/connectedhomeip/scripts/activate.sh
          else
            echo "activate.sh not found!" && exit 1
          fi
      - name: Build Firmware
        run: |
          set -e
          echo "Deactivating any Pigweed or CHIP Python venv..."
          deactivate 2>/dev/null || true
          unset VIRTUAL_ENV PW_PROJECT_ROOT PW_ROOT PW_PACKAGE_ROOT
          
          echo "Activating ESP-IDF + ESP-Matter..."
          source ~/esp/esp-idf/export.sh
          source ./export.sh
          
          PROJECT_DIR=$GITHUB_WORKSPACE/examples/all_device_types_app
          echo "Building project at: $PROJECT_DIR"
          ls -la "$PROJECT_DIR"
          cat "$PROJECT_DIR/CMakeLists.txt" | head -n 10 || echo " No CMakeLists.txt found!"

          idf.py -C "$PROJECT_DIR" set-target esp32h2
          idf.py -C "$PROJECT_DIR" build
      - name: Debug:locate firmware binaries
        run: |
          echo "Current directory: $(pwd)"
          find . -type f \( -name "*.bin" -o -name "*.elf" \) | sort
      - name: Prepare firmware info file
        run: |
          mkdir -p examples/all_device_types_app/build
          cat > examples/all_device_types_app/build/FLASH_INSTRUCTIONS.txt << 'EOF'
          ESP32-H2 All Device Types App - Firmware Flash Instructions
          ============================================================

          Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Commit: ${{ github.sha }}
          Target: ESP32-H2

          FLASH COMMANDS:
          ===============

          idf.py -p /dev/ttyUSB0 flash monitor

          BINARIES INCLUDED:
          ==================
          - bootloader.bin
          - partition-table.bin
          - all_device_types_app.bin
          - all_device_types_app.elf
          EOF
      - name: Debug build output
        run: |
          echo "Listing build outputs..."
          find . -type f -name "*.bin" -o -name "*.elf" | sort
      - name: Prepare and upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all_device_types_app_firmware
          path: |
            examples/all_device_types_app/build/*.bin
            examples/all_device_types_app/build/bootloader/*.bin
            examples/all_device_types_app/build/partition_table/*.bin
            examples/all_device_types_app/build/*.elf
            examples/all_device_types_app/build/*.map
            examples/all_device_types_app/build/FLASH_INSTRUCTIONS.txt
      - name: Disable cache compression (prevent disk overflow)
        run: |
          echo "ACTIONS_CACHE_COMPRESSION_LEVEL=0" >> $GITHUB_ENV
      - name: Build summary
        if: always()
        run: |
          echo "#Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then

            echo "" >> $GITHUB_STEP_SUMMARY

            echo "- **Target:** ESP32-H2" >> $GITHUB_STEP_SUMMARY
            echo "- **Project:** GPIO10 NMOS PWM Controller" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Build Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo " Download Firmware" >> $GITHUB_STEP_SUMMARY
            echo "Firmware binaries are available in the **Artifacts** section below." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Quick Flash Command" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "cd examples/gpio10_nmos" >> $GITHUB_STEP_SUMMARY
            echo "idf.py -p /dev/ttyUSB0 flash monitor" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo " Build Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the build logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi
